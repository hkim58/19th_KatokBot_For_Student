/**
 * ====================================
 * CalcBot.js - 계산기 봇 (초보자용 상세 주석 버전)
 * ====================================
 * 
 * 이 봇은 간단한 수식을 계산해주는 계산기 봇입니다.
 * 
 * 예시:
 *   사용자: "계산 1+1"
 *   봇: "결과: 2"
 *   
 *   사용자: "계산 10*5"
 *   봇: "결과: 50"
 *   
 *   사용자: "계산 100/4"
 *   봇: "결과: 25"
 */

// ====== 1단계: 봇 객체 가져오기 ======
// 메신저봇의 BotManager를 통해 현재 봇을 제어할 준비를 합니다
var bot = BotManager.getCurrentBot();

// ====== 2단계: 메시지 이벤트 리스너 등록 ======
// 카톡 메시지가 오면 자동으로 이 함수가 실행됩니다
bot.on("message", function(msg) {
    
    // ====== 3단계: "계산"으로 시작하는 메시지 확인 ======
    // indexOf("계산") == 0 의미:
    // - "계산"이라는 단어가 메시지 맨 앞(0번 위치)에 있는지 확인
    // - "계산 1+1" → true (계산으로 시작)
    // - "1+1 계산" → false (계산이 맨 앞이 아님)
    // - "안녕" → false (계산이 없음)
    //
    // ⚠️ 현재 코드의 문제점:
    // - "계산1+1" 처럼 공백 없이 입력하면 substring(3)에서 문제 발생
    // - 더 안전하게 하려면: indexOf("계산 ") == 0 사용 권장
    if (msg.content.indexOf("계산") == 0) {
        
        // ====== 4단계: try-catch로 에러 처리 준비 ======
        // try-catch 구조란?
        // - try { }: 시도할 코드를 넣는 곳
        // - catch(e) { }: 에러가 발생했을 때 실행할 코드
        // 
        // 계산기에서 왜 필요한가?
        // - "계산 1+1" → 정상 작동
        // - "계산 1++1" → 에러 발생! (잘못된 수식)
        // - 에러가 나도 봇이 멈추지 않고 안내 메시지를 보낼 수 있음
        try {
            // ====== 5단계: 수식 추출하기 ======
            // substring(3)의 의미:
            // - 인덱스 3번 위치부터 끝까지 잘라내기
            // 
            // "계산 1+1"의 각 문자 위치:
            // 인덱스: 0  1  2  3  4  5
            // 문  자: 계 산 공백 1  +  1
            // 
            // substring(3)을 하면 "1+1"만 남음
            // 
            // ⚠️ 주의: "계산1+1" 처럼 공백이 없으면?
            // → "1+1"이 아닌 "+1"이 됨 (첫 글자가 잘림)
            // 💡 해결법: trim()을 추가하면 앞뒤 공백 정리 가능
            var expr = msg.content.substring(3).trim();
            
            // ====== 6단계: 수식 계산하기 ======
            // new Function("return " + expr)() 의미:
            // - 문자열로 된 수식을 실제로 계산하는 방법
            // - expr이 "1+1"이면 → new Function("return 1+1")()
            // - 이것이 실행되면 → 2가 나옴
            // 
            // 왜 eval()을 안 쓰나요?
            // - eval()은 보안상 위험할 수 있음
            // - new Function()이 조금 더 안전한 방식
            //
            // ⚠️ 중요 경고:
            // - new Function()도 완전히 안전하지는 않음!
            // - 실제 서비스에서는 숫자와 연산자만 허용하는 검증 필수
            // - 예: if (!/^[0-9+\-*/().\s]+$/.test(expr)) 로 체크
            // 
            // 지원하는 연산:
            // - 덧셈: +
            // - 뺄셈: -
            // - 곱셈: *
            // - 나눗셈: /
            // - 괄호: ( )
            // - 예: "계산 (10+5)*2" → 30
            var result = new Function("return " + expr)();
            
            // ====== 7단계: 결과 답장하기 ======
            // 계산 결과를 "결과: " 라는 텍스트와 함께 답장
            // 예: result가 2면 → "결과: 2"
            //
            // 📝 특수한 결과값들:
            // - 1/0 → Infinity (무한대, 에러는 아님)
            // - -1/0 → -Infinity (음의 무한대)
            // - 0/0 → NaN (숫자가 아님, Not a Number)
            // 이런 값들은 사용자가 이해하기 어려울 수 있음
            msg.reply("결과: " + result);
            
        } catch(e) {
            // ====== 8단계: 에러 처리하기 ======
            // catch 블록: try에서 에러가 발생하면 여기로 옴
            // e: 에러 정보가 담긴 객체 (여기서는 사용 안함)
            // 
            // 에러가 나는 경우들:
            // - "계산 1++1" (연산자 중복)
            // - "계산 abc" (숫자가 아닌 문자)
            // - "계산 1+" (불완전한 수식)
            // - "계산 (" (닫히지 않은 괄호)
            msg.reply("올바른 수식을 입력해주세요!");
        }
    }
    
    // "계산"으로 시작하지 않는 메시지는 무시
});

/**
 * ========================================
 * 📌 핵심 처리 단계 요약
 * ========================================
 * 1. 문자열 파싱: "계산 1+1" → "1+1" 추출
 * 2. 안전성 검증: 숫자와 연산자만 있는지 확인 (권장)
 * 3. 계산 실행: new Function()으로 수식 계산
 * 4. 결과 응답: 정상값 또는 에러 메시지 전송
 * ========================================
 * 
 * ====== 메신저봇 동작 흐름 정리 ======
 * 
 * 1. 사용자가 "계산"으로 시작하는 메시지를 보냄
 * 2. "계산" 다음의 수식 부분만 추출 (trim으로 공백 제거)
 * 3. 수식을 실제로 계산 시도
 * 4. 성공하면 결과를 답장 (Infinity, NaN 포함)
 * 5. 실패하면 에러 메시지를 답장
 * 
 * ====== 주요 개념 정리 ======
 * 
 * - try-catch: 에러가 날 수 있는 코드를 안전하게 실행
 * - substring(): 문자열의 일부분만 잘라내기
 * - new Function(): 문자열을 코드로 실행 (eval보다 안전)
 * - +, -, *, /: 사칙연산 기호
 * 
 * ====== 실습 과제 ======
 * 
 * [초급]
 * 1. "계산" 대신 다른 명령어 사용 (예: "calc")
 * 2. 결과 메시지 꾸미기 (예: "🧮 답: ")
 * 3. 에러 메시지 바꾸기
 * 
 * [중급]
 * 4. 수식이 비어있을 때 처리
 *    if (expr.length == 0) {
 *        msg.reply("계산할 수식을 입력하세요!");
 *        return;
 *    }
 * 5. 결과를 소수점 2자리까지만 표시
 *    result = Math.round(result * 100) / 100;
 * 6. Infinity나 NaN 처리하기
 *    if (result === Infinity) {
 *        msg.reply("무한대는 계산할 수 없어요!");
 *    } else if (isNaN(result)) {
 *        msg.reply("올바른 숫자가 아니에요!");
 *    }
 * 
 * [고급]
 * 7. 더 안전한 계산 (숫자와 연산자만 허용)
 *    if (!/^[0-9+\-*/().\s]+$/.test(expr)) {
 *        msg.reply("숫자와 연산자만 사용하세요!");
 *        return;
 *    }
 * 8. 계산 기록 저장하기
 *    var history = [];
 *    history.push(expr + " = " + result);
 * 
 * ====== 개선된 코드 예시 (고급) ======
 * 
 * if (msg.content.indexOf("계산 ") == 0) {  // 공백 포함
 *     try {
 *         var expr = msg.content.substring(4).trim();  // 공백 제거
 *         
 *         // 빈 수식 체크
 *         if (expr.length == 0) {
 *             msg.reply("계산할 수식을 입력하세요!\n예: 계산 1+1");
 *             return;
 *         }
 *         
 *         // 안전한 문자만 허용
 *         if (!/^[0-9+\-*/().\s]+$/.test(expr)) {
 *             msg.reply("⚠️ 숫자와 +, -, *, / 만 사용 가능합니다!");
 *             return;
 *         }
 *         
 *         var result = new Function("return " + expr)();
 *         
 *         // 소수점 정리
 *         if (result % 1 !== 0) {  // 소수인 경우
 *             result = Math.round(result * 100) / 100;
 *         }
 *         
 *         msg.reply("🧮 " + expr + " = " + result);
 *         
 *     } catch(e) {
 *         msg.reply("❌ 계산할 수 없는 수식입니다.\n예: 1+1, 10*5, (2+3)*4");
 *     }
 * }
 * 
 * ====== 보안 주의사항 ======
 * 
 * ⚠️ eval()을 사용하면 안되는 이유:
 * - eval("1+1") → 2 (정상)
 * - eval("봇 종료 코드") → 위험! 봇이 종료될 수 있음
 * - eval()은 모든 JavaScript 코드를 실행할 수 있어 위험
 * 
 * new Function()도 완벽하게 안전하진 않지만 eval()보다 나음
 * 가장 안전한 방법은 직접 파싱하여 계산하는 것
 */