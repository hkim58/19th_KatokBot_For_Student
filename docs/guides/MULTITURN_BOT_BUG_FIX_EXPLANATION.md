# 🐛 멀티턴 봇 버그 수정 설명서

**작성일**: 2025-11-13  
**대상**: 메신저봇 프로그래밍을 배우는 비개발자 학생들  
**문서 목적**: CatBot_Multiturn의 API 오류 원인과 해결 방법을 쉽게 이해하기

---

## 📌 무엇이 문제였나요?

**증상**: 루나 봇에게 질문하면 항상 "미안하다냥... 지금 머리가 복잡해서 대답할 수 없다냥 😿" 메시지만 나옴

**원인**: AI에게 보내는 대화 내용이 잘못된 형식으로 전송됨

---

## 🎭 문제를 카페 주문으로 이해해보기

### 정상적인 카페 대화 (올바른 형식)
```
점원: "안녕하세요, 무엇을 도와드릴까요?"
손님: "아메리카노 하나 주세요"
점원: "네, 아메리카노 한 잔 준비하겠습니다"
손님: "아이스로 해주세요"
점원: "네, 아이스 아메리카노로 변경하겠습니다"
```

### 문제가 있던 대화 (잘못된 형식)
```
점원: "안녕하세요, 무엇을 도와드릴까요?"
손님: "아메리카노 하나 주세요"
점원: "네, 아메리카노 한 잔 준비하겠습니다"
손님: "아이스로 해주세요"
손님: "아이스로 해주세요"  ← 🔴 같은 말을 두 번 함!
```

**결과**: 점원이 혼란스러워서 주문을 받지 못함

---

## 💻 실제 코드에서 무슨 일이 일어났나요?

### 🔴 버그가 있던 코드의 동작 순서

```javascript
// 1단계: "루나 안녕"이라는 메시지를 받음
// 2단계: 메모리에 먼저 저장
ChatMemory.addMessage(room, author, "user", "안녕");

// 3단계: AI에게 보낼 메시지 목록 만들기
var messages = ChatMemory.buildMessages(room, author, "안녕");
```

#### 문제점 설명
1. **2단계**에서 "안녕"을 메모리에 저장 ✅
2. **3단계**에서 메시지 목록을 만들 때:
   - 메모리에 있는 "안녕"을 추가 ✅
   - buildMessages 함수 내부에서 "안녕"을 또 추가 ❌

결과: AI가 받는 메시지
```
[AI 성격 설정]
[사용자: 안녕]
[사용자: 안녕]  ← 중복!
```

### ✅ 수정된 코드의 동작 순서

```javascript
// 1단계: "루나 안녕"이라는 메시지를 받음
// 2단계: AI에게 보낼 메시지 목록 먼저 만들기
var messages = ChatMemory.buildMessages(room, author, "안녕");

// 3단계: API 호출 (AI에게 질문)
// 4단계: 응답을 받은 후에 메모리에 저장
ChatMemory.addMessage(room, author, "user", "안녕");
ChatMemory.addMessage(room, author, "ai", AI응답);
```

#### 개선된 점
1. 먼저 메시지 목록을 만들고
2. AI 응답을 받은 후에
3. 질문과 답변을 함께 메모리에 저장

결과: AI가 받는 메시지
```
[AI 성격 설정]
[이전 대화들...]
[사용자: 안녕]  ← 한 번만!
```

---

## 🎯 핵심 교훈

### 1. **순서가 중요하다**
   - 저장 → 읽기 (X)
   - 읽기 → 저장 (O)

### 2. **중복 확인이 필요하다**
   - 같은 데이터를 두 번 처리하지 않도록 주의

### 3. **AI API는 형식을 엄격하게 검사한다**
   - user → assistant → user → assistant 순서 유지
   - 같은 역할(user)이 연속으로 오면 거부

---

## 📝 실습: 버그 찾기 연습

다음 상황에서 문제를 찾아보세요:

### 문제 상황
```javascript
// 장바구니에 상품 추가하기
cart.addItem("사과");
var items = cart.getAllItems();  // ["사과"]
items.push("사과");  // ["사과", "사과"]
// 결제할 때 사과가 2개로 계산됨!
```

**답**: 이미 cart에 추가한 사과를 items 배열에 또 추가해서 중복 발생

---

## 🔍 디버깅 팁

1. **로그 확인하기**
   - 메신저봇 앱의 Log 탭에서 에러 메시지 확인
   - `[CatBot_Multiturn]`으로 시작하는 로그 찾기

2. **단계별 확인**
   - 각 단계에서 데이터가 어떻게 변하는지 추적
   - 중복이나 누락이 없는지 확인

3. **작은 부분부터 테스트**
   - 전체를 한번에 테스트하지 말고
   - 한 기능씩 확인하기

---

## 💡 이런 버그를 예방하는 방법

1. **명확한 역할 분리**
   - 저장 함수는 저장만
   - 읽기 함수는 읽기만
   - 섞이지 않도록 주의

2. **주석 활용**
   ```javascript
   // 아직 메모리에 저장 안함
   var messages = buildMessages();
   
   // 이제 메모리에 저장
   addMessage();
   ```

3. **테스트 케이스 작성**
   - 첫 대화 테스트
   - 연속 대화 테스트
   - 긴 대화 테스트

---

## 🎉 결론

이번 버그는 **"같은 메시지를 두 번 추가하는 중복 문제"**였습니다.

마치 친구에게 같은 말을 두 번 연속으로 하면 이상하게 느껴지는 것처럼, AI도 같은 사용자 메시지가 연속으로 오면 혼란스러워합니다.

**해결 방법**: 
- 메시지를 보내기 전에 준비하고
- 응답을 받은 후에 저장하는
- 올바른 순서로 코드를 재배열했습니다.

---

## 📚 더 공부하고 싶다면

- [메신저봇 완전 학습 가이드](MESSENGER_BOT_COMPLETE_LEARNING_GUIDE.md)
- [자주 겪는 오류 해결법](BEGINNER_COMMON_ERRORS.md)
- [메신저봇 개발 표준](MESSENGER_BOT_DEVELOPMENT_STANDARDS.md)

---

**도움이 필요하면**: 멘토나 강사에게 이 문서를 보여주며 질문하세요! 😊